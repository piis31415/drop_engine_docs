<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Object lifetime management</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Object lifetime management</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md7915"></a></p>
<p>A handle may be created when any new node-addon-api Value and its subclasses is created or returned.</p>
<p>As the methods and classes within the node-addon-api are used, handles to objects in the heap for the underlying VM may be created. A handle may be created when any new node-addon-api Value or one of its subclasses is created or returned. These handles must hold the objects 'live' until they are no longer required by the native code, otherwise the objects could be collected by the garbage collector before the native code was finished using them.</p>
<p>As handles are created they are associated with a 'scope'. The lifespan for the default scope is tied to the lifespan of the native method call. The result is that, by default, handles remain valid and the objects associated with these handles will be held live for the lifespan of the native method call.</p>
<p>In many cases, however, it is necessary that the handles remain valid for either a shorter or longer lifespan than that of the native method. The sections which follow describe the node-addon-api classes and methods that than can be used to change the handle lifespan from the default.</p>
<h1><a class="anchor" id="autotoc_md7916"></a>
Making handle lifespan shorter than that of the native method</h1>
<p>It is often necessary to make the lifespan of handles shorter than the lifespan of a native method. For example, consider a native method that has a loop which creates a number of values and does something with each of the values, one at a time:</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; LOOP_MAX; i++) {</div>
<div class="line">  std::string name = std::string(<span class="stringliteral">&quot;inner-scope&quot;</span>) + std::to_string(i);</div>
<div class="line">  <a class="code hl_class" href="class_napi_1_1_value.html">Napi::Value</a> newValue = <a class="code hl_function" href="class_napi_1_1_string.html#a6689d69d07bad4eea2be440333320925">Napi::String::New</a>(info.Env(), name.c_str());</div>
<div class="line">  <span class="comment">// do something with newValue</span></div>
<div class="line">};</div>
<div class="ttc" id="aclass_napi_1_1_string_html_a6689d69d07bad4eea2be440333320925"><div class="ttname"><a href="class_napi_1_1_string.html#a6689d69d07bad4eea2be440333320925">Napi::String::New</a></div><div class="ttdeci">static String New(napi_env env, const std::string &amp;value)</div><div class="ttdoc">Creates a new String value from a UTF-8 encoded C++ string.</div><div class="ttdef"><b>Definition</b> napi-inl.h:677</div></div>
<div class="ttc" id="aclass_napi_1_1_value_html"><div class="ttname"><a href="class_napi_1_1_value.html">Napi::Value</a></div><div class="ttdef"><b>Definition</b> napi.h:190</div></div>
</div><!-- fragment --><p>This would result in a large number of handles being created, consuming substantial resources. In addition, even though the native code could only use the most recently created value, all of the previously created values would also be kept alive since they all share the same scope.</p>
<p>To handle this case, node-addon-api provides the ability to establish a new 'scope' to which newly created handles will be associated. Once those handles are no longer required, the scope can be deleted and any handles associated with the scope are invalidated. The <code><a class="el" href="class_napi_1_1_handle_scope.html">Napi::HandleScope</a></code> and <code><a class="el" href="class_napi_1_1_escapable_handle_scope.html">Napi::EscapableHandleScope</a></code> classes are provided by node-addon-api for creating additional scopes.</p>
<p>node-addon-api only supports a single nested hierarchy of scopes. There is only one active scope at any time, and all new handles will be associated with that scope while it is active. Scopes must be deleted in the reverse order from which they are opened. In addition, all scopes created within a native method must be deleted before returning from that method. Since <code>Napi::HandleScopes</code> are typically stack allocated the compiler will take care of deletion, however, care must be taken to create the scope in the right place such that you achieve the desired lifetime.</p>
<p>Taking the earlier example, creating a <code><a class="el" href="class_napi_1_1_handle_scope.html">Napi::HandleScope</a></code> in the innner loop would ensure that at most a single new value is held alive throughout the execution of the loop:</p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; LOOP_MAX; i++) {</div>
<div class="line">  <a class="code hl_class" href="class_napi_1_1_handle_scope.html">Napi::HandleScope</a> scope(info.Env());</div>
<div class="line">  std::string name = std::string(<span class="stringliteral">&quot;inner-scope&quot;</span>) + std::to_string(i);</div>
<div class="line">  <a class="code hl_class" href="class_napi_1_1_value.html">Napi::Value</a> newValue = <a class="code hl_function" href="class_napi_1_1_string.html#a6689d69d07bad4eea2be440333320925">Napi::String::New</a>(info.Env(), name.c_str());</div>
<div class="line">  <span class="comment">// do something with neValue</span></div>
<div class="line">};</div>
<div class="ttc" id="aclass_napi_1_1_handle_scope_html"><div class="ttname"><a href="class_napi_1_1_handle_scope.html">Napi::HandleScope</a></div><div class="ttdef"><b>Definition</b> napi.h:1700</div></div>
</div><!-- fragment --><p>When nesting scopes, there are cases where a handle from an inner scope needs to live beyond the lifespan of that scope. node-addon-api provides the <code><a class="el" href="class_napi_1_1_escapable_handle_scope.html">Napi::EscapableHandleScope</a></code> with the <code>Escape</code> method in order to support this case. An escapable scope allows one object to be 'promoted' so that it 'escapes' the current scope and the lifespan of the handle changes from the current scope to that of the outer scope. The <code>Escape</code> method can only be called once for a given <code><a class="el" href="class_napi_1_1_escapable_handle_scope.html">Napi::EscapableHandleScope</a></code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
