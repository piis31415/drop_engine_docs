<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: ThreadSafeFunction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">ThreadSafeFunction</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md8003"></a></p>
<p>JavaScript functions can normally only be called from a native addon's main thread. If an addon creates additional threads, then node-addon-api functions that require a <code><a class="el" href="class_napi_1_1_env.html">Napi::Env</a></code>, <code><a class="el" href="class_napi_1_1_value.html">Napi::Value</a></code>, or <code><a class="el" href="class_napi_1_1_reference.html">Napi::Reference</a></code> must not be called from those threads.</p>
<p>When an addon has additional threads and JavaScript functions need to be invoked based on the processing completed by those threads, those threads must communicate with the addon's main thread so that the main thread can invoke the JavaScript function on their behalf. The thread-safe function APIs provide an easy way to do this.</p>
<p>These APIs provide the type <code>Napi::ThreadSafeFunction</code> as well as APIs to create, destroy, and call objects of this type. <code>Napi::ThreadSafeFunction::New()</code> creates a persistent reference that holds a JavaScript function which can be called from multiple threads. The calls happen asynchronously. This means that values with which the JavaScript callback is to be called will be placed in a queue, and, for each value in the queue, a call will eventually be made to the JavaScript function.</p>
<p><code>Napi::ThreadSafeFunction</code> objects are destroyed when every thread which uses the object has called <code>Release()</code> or has received a return status of <code>napi_closing</code> in response to a call to <code>BlockingCall()</code> or <code>NonBlockingCall()</code>. The queue is emptied before the <code>Napi::ThreadSafeFunction</code> is destroyed. It is important that <code>Release()</code> be the last API call made in conjunction with a given <code>Napi::ThreadSafeFunction</code>, because after the call completes, there is no guarantee that the <code>Napi::ThreadSafeFunction</code> is still allocated. For the same reason it is also important that no more use be made of a thread-safe function after receiving a return value of <code>napi_closing</code> in response to a call to <code>BlockingCall()</code> or <code>NonBlockingCall()</code>. Data associated with the <code>Napi::ThreadSafeFunction</code> can be freed in its <code>Finalizer</code> callback which was passed to <code>ThreadSafeFunction::New()</code>.</p>
<p>Once the number of threads making use of a <code>Napi::ThreadSafeFunction</code> reaches zero, no further threads can start making use of it by calling <code>Acquire()</code>. In fact, all subsequent API calls associated with it, except <code>Release()</code>, will return an error value of <code>napi_closing</code>.</p>
<h1><a class="anchor" id="autotoc_md8004"></a>
Methods</h1>
<h2><a class="anchor" id="autotoc_md8005"></a>
Constructor</h2>
<p>Creates a new empty instance of <code>Napi::ThreadSafeFunction</code>.</p>
<div class="fragment"><div class="line">Napi::Function::ThreadSafeFunction();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8006"></a>
Constructor</h2>
<p>Creates a new instance of the <code>Napi::ThreadSafeFunction</code> object.</p>
<div class="fragment"><div class="line">Napi::ThreadSafeFunction::ThreadSafeFunction(napi_threadsafe_function tsfn);</div>
</div><!-- fragment --><ul>
<li><code>tsfn</code>: The <code>napi_threadsafe_function</code> which is a handle for an existing thread-safe function.</li>
</ul>
<p>Returns a non-empty <code>Napi::ThreadSafeFunction</code> instance.</p>
<h2><a class="anchor" id="autotoc_md8007"></a>
New</h2>
<p>Creates a new instance of the <code>Napi::ThreadSafeFunction</code> object. The <code>New</code> function has several overloads for the various optional parameters: skip the optional parameter for that specific overload.</p>
<div class="fragment"><div class="line">New(<a class="code hl_struct" href="structnapi__env____.html">napi_env</a> env,</div>
<div class="line">    <span class="keyword">const</span> Function&amp; callback,</div>
<div class="line">    <span class="keyword">const</span> Object&amp; resource,</div>
<div class="line">    ResourceString resourceName,</div>
<div class="line">    <span class="keywordtype">size_t</span> maxQueueSize,</div>
<div class="line">    <span class="keywordtype">size_t</span> initialThreadCount,</div>
<div class="line">    ContextType* context,</div>
<div class="line">    Finalizer finalizeCallback,</div>
<div class="line">    FinalizerDataType* data);</div>
<div class="ttc" id="astructnapi__env_____html"><div class="ttname"><a href="structnapi__env____.html">napi_env__</a></div><div class="ttdef"><b>Definition</b> node_api.cc:30</div></div>
</div><!-- fragment --><ul>
<li><code>env</code>: The <code>napi_env</code> environment in which to construct the <code>Napi::ThreadSafeFunction</code> object.</li>
<li><code>callback</code>: The <code>Function</code> to call from another thread.</li>
<li><code>[optional] resource</code>: An object associated with the async work that will be passed to possible async_hooks init hooks.</li>
<li><code>resourceName</code>: A JavaScript string to provide an identifier for the kind of resource that is being provided for diagnostic information exposed by the async_hooks API.</li>
<li><code>maxQueueSize</code>: Maximum size of the queue. <code>0</code> for no limit.</li>
<li><code>initialThreadCount</code>: The initial number of threads, including the main thread, which will be making use of this function.</li>
<li><code>[optional] context</code>: Data to attach to the resulting <code>ThreadSafeFunction</code>.</li>
<li><code>[optional] finalizeCallback</code>: Function to call when the <code>ThreadSafeFunction</code> is being destroyed. This callback will be invoked on the main thread when the thread-safe function is about to be destroyed. It receives the context and the finalize data given during construction (if given), and provides an opportunity for cleaning up after the threads e.g. by calling <code>uv_thread_join()</code>. It is important that, aside from the main loop thread, there be no threads left using the thread-safe function after the finalize callback completes. Must implement <code>void operator()(Env env, DataType* data,
  Context* hint)</code>, skipping <code>data</code> or <code>hint</code> if they are not provided. Can be retreived via <code>GetContext()</code>.</li>
<li><code>[optional] data</code>: Data to be passed to <code>finalizeCallback</code>.</li>
</ul>
<p>Returns a non-empty <code>Napi::ThreadSafeFunction</code> instance.</p>
<h2><a class="anchor" id="autotoc_md8008"></a>
Acquire</h2>
<p>Add a thread to this thread-safe function object, indicating that a new thread will start making use of the thread-safe function.</p>
<div class="fragment"><div class="line">napi_status Napi::ThreadSafeFunction::Acquire()</div>
</div><!-- fragment --><p>Returns one of:</p><ul>
<li><code>napi_ok</code>: The thread has successfully acquired the thread-safe function for its use.</li>
<li><code>napi_closing</code>: The thread-safe function has been marked as closing via a previous call to <code>Abort()</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md8009"></a>
Release</h2>
<p>Indicate that an existing thread will stop making use of the thread-safe function. A thread should call this API when it stops making use of this thread-safe function. Using any thread-safe APIs after having called this API has undefined results in the current thread, as it may have been destroyed.</p>
<div class="fragment"><div class="line">napi_status Napi::ThreadSafeFunction::Release()</div>
</div><!-- fragment --><p>Returns one of:</p><ul>
<li><code>napi_ok</code>: The thread-safe function has been successfully released.</li>
<li><code>napi_invalid_arg</code>: The thread-safe function's thread-count is zero.</li>
<li><code>napi_generic_failure</code>: A generic error occurred when attemping to release the thread-safe function.</li>
</ul>
<h2><a class="anchor" id="autotoc_md8010"></a>
Abort</h2>
<p>"Abort" the thread-safe function. This will cause all subsequent APIs associated with the thread-safe function except <code>Release()</code> to return <code>napi_closing</code> even before its reference count reaches zero. In particular, <code>BlockingCall</code> and <code>NonBlockingCall()</code> will return <code>napi_closing</code>, thus informing the threads that it is no longer possible to make asynchronous calls to the thread-safe function. This can be used as a criterion for terminating the thread. Upon receiving a return value of <code>napi_closing</code> from a thread-safe function call a thread must make no further use of the thread-safe function because it is no longer guaranteed to be allocated.</p>
<div class="fragment"><div class="line">napi_status Napi::ThreadSafeFunction::Abort()</div>
</div><!-- fragment --><p>Returns one of:</p><ul>
<li><code>napi_ok</code>: The thread-safe function has been successfully aborted.</li>
<li><code>napi_invalid_arg</code>: The thread-safe function's thread-count is zero.</li>
<li><code>napi_generic_failure</code>: A generic error occurred when attemping to abort the thread-safe function.</li>
</ul>
<h2><a class="anchor" id="autotoc_md8011"></a>
BlockingCall / NonBlockingCall</h2>
<p>Calls the Javascript function in either a blocking or non-blocking fashion.</p><ul>
<li><code>BlockingCall()</code>: the API blocks until space becomes available in the queue. Will never block if the thread-safe function was created with a maximum queue size of <code>0</code>.</li>
<li><code>NonBlockingCall()</code>: will return <code>napi_queue_full</code> if the queue was full, preventing data from being successfully added to the queue.</li>
</ul>
<p>There are several overloaded implementations of <code>BlockingCall()</code> and <code>NonBlockingCall()</code> for use with optional parameters: skip the optional parameter for that specific overload.</p>
<div class="fragment"><div class="line">napi_status Napi::ThreadSafeFunction::BlockingCall(DataType* data, Callback callback) <span class="keyword">const</span></div>
<div class="line"> </div>
<div class="line">napi_status Napi::ThreadSafeFunction::NonBlockingCall(DataType* data, Callback callback) <span class="keyword">const</span></div>
</div><!-- fragment --><ul>
<li><code>[optional] data</code>: Data to pass to <code>callback</code>.</li>
<li><code>[optional] callback</code>: C++ function that is invoked on the main thread. The callback receives the <code>ThreadSafeFunction</code>'s JavaScript callback function to call as an <code><a class="el" href="class_napi_1_1_function.html">Napi::Function</a></code> in its parameters and the <code>DataType*</code> data pointer (if provided). Must implement <code>void operator()(Napi::Env env, Function
  jsCallback, DataType* data)</code>, skipping <code>data</code> if not provided. It is not necessary to call into JavaScript via <code>MakeCallback()</code> because N-API runs <code>callback</code> in a context appropriate for callbacks.</li>
</ul>
<p>Returns one of:</p><ul>
<li><code>napi_ok</code>: The call was successfully added to the queue.</li>
<li><code>napi_queue_full</code>: The queue was full when trying to call in a non-blocking method.</li>
<li><code>napi_closing</code>: The thread-safe function is aborted and cannot accept more calls.</li>
<li><code>napi_invalid_arg</code>: The thread-safe function is closed.</li>
<li><code>napi_generic_failure</code>: A generic error occurred when attemping to add to the queue.</li>
</ul>
<h1><a class="anchor" id="autotoc_md8012"></a>
Example</h1>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;chrono&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;thread&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;napi.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_napi.html">Napi</a>;</div>
<div class="line"> </div>
<div class="line">std::thread nativeThread;</div>
<div class="line">ThreadSafeFunction tsfn;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_napi_1_1_value.html">Value</a> Start( <span class="keyword">const</span> <a class="code hl_class" href="class_napi_1_1_callback_info.html">CallbackInfo</a>&amp; info )</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_class" href="class_napi_1_1_env.html">Napi::Env</a> env = info.Env();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ( info.Length() &lt; 2 )</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">throw</span> TypeError::New( env, <span class="stringliteral">&quot;Expected two arguments&quot;</span> );</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !info[0].IsFunction() )</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">throw</span> TypeError::New( env, <span class="stringliteral">&quot;Expected first arg to be function&quot;</span> );</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !info[1].IsNumber() )</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">throw</span> TypeError::New( env, <span class="stringliteral">&quot;Expected second arg to be number&quot;</span> );</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">int</span> count = info[1].As&lt;<a class="code hl_class" href="class_napi_1_1_number.html">Number</a>&gt;().Int32Value();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create a ThreadSafeFunction</span></div>
<div class="line">  tsfn = ThreadSafeFunction::New(</div>
<div class="line">      env,</div>
<div class="line">      info[0].As&lt;Function&gt;(),  <span class="comment">// JavaScript function called asynchronously</span></div>
<div class="line">      <span class="stringliteral">&quot;Resource Name&quot;</span>,         <span class="comment">// Name</span></div>
<div class="line">      0,                       <span class="comment">// Unlimited queue</span></div>
<div class="line">      1,                       <span class="comment">// Only one thread will use this initially</span></div>
<div class="line">      []( <a class="code hl_class" href="class_napi_1_1_env.html">Napi::Env</a> ) {        <span class="comment">// Finalizer used to clean threads up</span></div>
<div class="line">        nativeThread.join();</div>
<div class="line">      } );</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create a native thread</span></div>
<div class="line">  nativeThread = std::thread( [count] {</div>
<div class="line">    <span class="keyword">auto</span> callback = []( <a class="code hl_class" href="class_napi_1_1_env.html">Napi::Env</a> env, <a class="code hl_class" href="class_napi_1_1_function.html">Function</a> jsCallback, <span class="keywordtype">int</span>* value ) {</div>
<div class="line">      <span class="comment">// Transform native data into JS data, passing it to the provided </span></div>
<div class="line">      <span class="comment">// `jsCallback` -- the TSFN&#39;s JavaScript function.</span></div>
<div class="line">      jsCallback.Call( {Number::New( env, *value )} );</div>
<div class="line">      </div>
<div class="line">      <span class="comment">// We&#39;re finished with the data.</span></div>
<div class="line">      <span class="keyword">delete</span> value;</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; count; i++ )</div>
<div class="line">    {</div>
<div class="line">      <span class="comment">// Create new data</span></div>
<div class="line">      <span class="keywordtype">int</span>* value = <span class="keyword">new</span> int( clock() );</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Perform a blocking call</span></div>
<div class="line">      napi_status status = tsfn.BlockingCall( value, callback );</div>
<div class="line">      <span class="keywordflow">if</span> ( status != napi_ok )</div>
<div class="line">      {</div>
<div class="line">        <span class="comment">// Handle error</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      std::this_thread::sleep_for( std::chrono::seconds( 1 ) );</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Release the thread-safe function</span></div>
<div class="line">    tsfn.Release();</div>
<div class="line">  } );</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> Boolean::New(env, <span class="keyword">true</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="class_napi_1_1_object.html">Napi::Object</a> Init( <a class="code hl_class" href="class_napi_1_1_env.html">Napi::Env</a> env, <a class="code hl_class" href="class_napi_1_1_object.html">Object</a> exports )</div>
<div class="line">{</div>
<div class="line">  exports.<a class="code hl_function" href="class_napi_1_1_object.html#a96eae03d64989f9a893897b37f9eb1b8">Set</a>( <span class="stringliteral">&quot;start&quot;</span>, Function::New( env, Start ) );</div>
<div class="line">  <span class="keywordflow">return</span> exports;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">NODE_API_MODULE( clock, Init )</div>
<div class="ttc" id="aclass_napi_1_1_callback_info_html"><div class="ttname"><a href="class_napi_1_1_callback_info.html">Napi::CallbackInfo</a></div><div class="ttdef"><b>Definition</b> napi.h:1340</div></div>
<div class="ttc" id="aclass_napi_1_1_env_html"><div class="ttname"><a href="class_napi_1_1_env.html">Napi::Env</a></div><div class="ttdef"><b>Definition</b> napi.h:162</div></div>
<div class="ttc" id="aclass_napi_1_1_function_html"><div class="ttname"><a href="class_napi_1_1_function.html">Napi::Function</a></div><div class="ttdef"><b>Definition</b> napi.h:956</div></div>
<div class="ttc" id="aclass_napi_1_1_number_html"><div class="ttname"><a href="class_napi_1_1_number.html">Napi::Number</a></div><div class="ttdoc">A JavaScript number value.</div><div class="ttdef"><b>Definition</b> napi.h:295</div></div>
<div class="ttc" id="aclass_napi_1_1_object_html"><div class="ttname"><a href="class_napi_1_1_object.html">Napi::Object</a></div><div class="ttdoc">A JavaScript object value.</div><div class="ttdef"><b>Definition</b> napi.h:464</div></div>
<div class="ttc" id="aclass_napi_1_1_object_html_a96eae03d64989f9a893897b37f9eb1b8"><div class="ttname"><a href="class_napi_1_1_object.html#a96eae03d64989f9a893897b37f9eb1b8">Napi::Object::Set</a></div><div class="ttdeci">void Set(napi_value key, const ValueType &amp;value)</div><div class="ttdoc">Sets a property.</div><div class="ttdef"><b>Definition</b> napi-inl.h:1022</div></div>
<div class="ttc" id="aclass_napi_1_1_value_html"><div class="ttname"><a href="class_napi_1_1_value.html">Napi::Value</a></div><div class="ttdef"><b>Definition</b> napi.h:190</div></div>
<div class="ttc" id="anamespace_napi_html"><div class="ttname"><a href="namespace_napi.html">Napi</a></div><div class="ttdef"><b>Definition</b> napi-inl.h:15</div></div>
</div><!-- fragment --><p>The above code can be used from JavaScript as follows:</p>
<div class="fragment"><div class="line">const { start } = require(&#39;bindings&#39;)(&#39;clock&#39;);</div>
<div class="line"> </div>
<div class="line">start(function () {</div>
<div class="line">    console.log(&quot;JavaScript callback called with arguments&quot;, Array.from(arguments));</div>
<div class="line">}, 5);</div>
</div><!-- fragment --><p>When executed, the output will show the value of <code>clock()</code> five times at one second intervals:</p>
<div class="fragment"><div class="line">JavaScript callback called with arguments [ 84745 ]</div>
<div class="line">JavaScript callback called with arguments [ 103211 ]</div>
<div class="line">JavaScript callback called with arguments [ 104516 ]</div>
<div class="line">JavaScript callback called with arguments [ 105104 ]</div>
<div class="line">JavaScript callback called with arguments [ 105691 ]</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
