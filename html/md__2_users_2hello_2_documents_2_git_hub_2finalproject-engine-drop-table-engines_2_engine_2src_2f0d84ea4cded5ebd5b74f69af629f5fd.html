<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: async-exit-hook</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">async-exit-hook</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md2496"></a></p>
<p><a href="https://travis-ci.org/Tapppi/async-exit-hook"><img src="https://api.travis-ci.org/Tapppi/async-exit-hook.svg" alt="Build Status" style="pointer-events: none;" class="inline"/></a> <a href="https://coveralls.io/github/Tapppi/async-exit-hook?branch=master"><img src="https://coveralls.io/repos/github/Tapppi/async-exit-hook/badge.svg?branch=master" alt="Coverage Status" style="pointer-events: none;" class="inline"/></a></p>
<blockquote class="doxtable">
<p>&zwj;Run some code when the process exits </p>
</blockquote>
<p>The &lsquo;process.on('exit&rsquo;)` event doesn't catch all the ways a process can exit. This module catches:</p>
<ul>
<li>process SIGINT, SIGTERM and SIGHUP, SIGBREAK signals <br  />
</li>
<li>process beforeExit and exit events <br  />
</li>
<li>PM2 clustering process shutdown message (<a href="http://pm2.keymetrics.io/docs/usage/cluster-mode/#graceful-reload">PM2 graceful reload</a>) <br  />
</li>
</ul>
<p>Useful for cleaning up. You can also include async handlers, and add custom events to hook and exit on.</p>
<p>Forked and pretty much rewritten from <a href="https://npmjs.com/package/exit-hook">exit-hook</a>.</p>
<h1><a class="anchor" id="autotoc_md2497"></a>
Install</h1>
<div class="fragment"><div class="line">$ npm install --save async-exit-hook</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2498"></a>
Usage</h1>
<h2><a class="anchor" id="autotoc_md2499"></a>
Considerations and warning</h2>
<h3><a class="anchor" id="autotoc_md2500"></a>
On <code>process.exit()</code> and asynchronous code</h3>
<p><b>If you use asynchronous exit hooks, DO NOT use <code>process.exit()</code> to exit. The <code>exit</code> event DOES NOT support asynchronous code.</b> &gt;['beforeExit' is not emitted for conditions causing explicit termination, such as process.exit()] (<a href="https://nodejs.org/api/process.html#process_event_beforeexit">https://nodejs.org/api/process.html#process_event_beforeexit</a>)</p>
<h3><a class="anchor" id="autotoc_md2501"></a>
Windows and <code>process.kill(signal)</code></h3>
<p>On windows <code>process.kill(signal)</code> immediately kills the process, and does not fire signal events, and as such, cannot be used to gracefully exit. See <em>Clustering and child processes</em> for a workaround when killing child processes. I'm planning to support gracefully exiting with async support on windows soon.</p>
<h2><a class="anchor" id="autotoc_md2502"></a>
Clustering and child processes</h2>
<p>If you use custom clustering / child processes, you can gracefully shutdown your child process by sending a shutdown message (&lsquo;childProc.send('shutdown&rsquo;)`).</p>
<h2><a class="anchor" id="autotoc_md2503"></a>
Example</h2>
<div class="fragment"><div class="line">const exitHook = require(&#39;async-exit-hook&#39;);</div>
<div class="line"> </div>
<div class="line">exitHook(() =&gt; {</div>
<div class="line">    console.log(&#39;exiting&#39;);</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">// you can add multiple hooks, even across files</div>
<div class="line">exitHook(() =&gt; {</div>
<div class="line">    console.log(&#39;exiting 2&#39;);</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">// you can add async hooks by accepting a callback</div>
<div class="line">exitHook(callback =&gt; {</div>
<div class="line">    setTimeout(() =&gt; {</div>
<div class="line">        console.log(&#39;exiting 3&#39;);</div>
<div class="line">        callback();</div>
<div class="line">    }, 1000);</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">// You can hook uncaught errors with uncaughtExceptionHandler(), consequently adding </div>
<div class="line">// async support to uncaught errors (normally uncaught errors result in a synchronous exit).</div>
<div class="line">exitHook.uncaughtExceptionHandler(err =&gt; {</div>
<div class="line">    console.error(err);</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">// You can hook unhandled rejections with unhandledRejectionHandler()</div>
<div class="line">exitHook.unhandledRejectionHandler(err =&gt; {</div>
<div class="line">    console.error(err);</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">// You can add multiple uncaught error handlers</div>
<div class="line">// Add the second parameter (callback) to indicate async hooks</div>
<div class="line">exitHook.uncaughtExceptionHandler((err, callback) =&gt; {</div>
<div class="line">    sendErrorToCloudOrWhatever(err) // Returns promise</div>
<div class="line">        .then(() =&gt; { </div>
<div class="line">             console.log(&#39;Sent err to cloud&#39;); </div>
<div class="line">         });</div>
<div class="line">        .catch(sendError =&gt; {</div>
<div class="line">             console.error(&#39;Error sending to cloud: &#39;, err.stack));</div>
<div class="line">        })</div>
<div class="line">        .then(() =&gt; callback);</div>
<div class="line">    });</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">// Add exit hooks for a signal or custom message:</div>
<div class="line"> </div>
<div class="line">// Custom signal</div>
<div class="line">// Arguments are `signal, exitCode` (SIGBREAK is already handled, this is an example)</div>
<div class="line">exitHook.hookEvent(&#39;SIGBREAK&#39;, 21);</div>
<div class="line"> </div>
<div class="line">// process event: `message` with a filter</div>
<div class="line">// filter gets all arguments passed to *handler*: `process.on(message, *handler*)`</div>
<div class="line">// Exits on process event `message` with msg `customShutdownMessage` only</div>
<div class="line">exitHook.hookEvent(&#39;message&#39;, 0, msg =&gt; msg !== &#39;customShutdownMessage&#39;);</div>
<div class="line"> </div>
<div class="line">// All async hooks will work with uncaught errors when you have specified an uncaughtExceptionHandler</div>
<div class="line">throw new Error(&#39;awesome&#39;);</div>
<div class="line"> </div>
<div class="line">//=&gt; // Sync uncaughtExcpetion hooks called and retun</div>
<div class="line">//=&gt; &#39;[Error: awesome]&#39;</div>
<div class="line">//=&gt; // Sync hooks called and retun</div>
<div class="line">//=&gt; &#39;exiting&#39;</div>
<div class="line">//=&gt; &#39;exiting 2&#39;</div>
<div class="line">//=&gt; // Async uncaughtException hooks return</div>
<div class="line">//=&gt; &#39;Sent error to cloud&#39;</div>
<div class="line">//=&gt; // Sync uncaughtException hooks return</div>
<div class="line">//=&gt; &#39;exiting 3&#39;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2504"></a>
License</h1>
<p>MIT © Tapani Moilanen <br  />
 MIT © <a href="http://sindresorhus.com">Sindre Sorhus</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
